extend schema @link(url: "https://specs.apollo.dev/federation/v2.10", import: ["@key", "@external", "@shareable"])

# Custom scalars
scalar DateTime
scalar Date

# =============================================================================
# ENUMS - Structured query types (NO free-text allowed per RFC)
# =============================================================================

enum CarePlanStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ACHIEVED
  NOT_ACHIEVED
  CANCELLED
}

enum GoalPriority {
  HIGH
  MEDIUM
  LOW
}

enum InterventionType {
  MEDICATION
  PROCEDURE
  LIFESTYLE
  MONITORING
  REFERRAL
  EDUCATION
  FOLLOW_UP
}

enum InterventionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DEFERRED
}

enum CarePlanQueryFilter {
  BY_PATIENT
  BY_PROVIDER
  BY_STATUS
  BY_CONDITION
}

enum TemplateCategory {
  CHRONIC_DISEASE
  PREVENTIVE_CARE
  POST_PROCEDURE
  MEDICATION_MANAGEMENT
  LIFESTYLE_MODIFICATION
}

# =============================================================================
# MAIN TYPES
# =============================================================================

type CarePlan @key(fields: "id") {
  id: ID!
  patient: Patient!

  # Plan metadata
  title: String!
  status: CarePlanStatus!

  # Conditions being addressed (ICD-10 codes)
  conditionCodes: [String!]!

  # Plan components
  goals: [CarePlanGoal!]!
  interventions: [CarePlanIntervention!]!

  # Timeline
  startDate: Date!
  targetEndDate: Date
  actualEndDate: Date

  # Review schedule
  nextReviewDate: Date
  lastReviewedAt: DateTime
  lastReviewedBy: ID

  # Source tracking
  sourceTranscriptionId: ID
  sourceRAGSynthesisId: ID
  templateId: ID

  # Audit
  createdAt: DateTime!
  createdBy: ID!
  updatedAt: DateTime!
}

type CarePlanGoal {
  id: ID!

  # Goal details
  description: String!
  targetValue: String
  targetDate: Date

  # Status
  status: GoalStatus!
  priority: GoalPriority!

  # Progress tracking
  progressNotes: [GoalProgressNote!]!
  currentValue: String
  percentComplete: Int

  # Linked interventions
  linkedInterventionIds: [ID!]!

  # Evidence
  guidelineReference: String

  createdAt: DateTime!
  updatedAt: DateTime!
}

type GoalProgressNote {
  id: ID!
  note: String!
  value: String
  recordedAt: DateTime!
  recordedBy: ID!
}

type CarePlanIntervention {
  id: ID!

  # Intervention details
  type: InterventionType!
  description: String!

  # For medication interventions
  medicationCode: String
  dosage: String
  frequency: String

  # For procedure/referral interventions
  procedureCode: String
  referralSpecialty: String

  # Scheduling
  status: InterventionStatus!
  scheduledDate: Date
  completedDate: Date

  # Instructions
  patientInstructions: String
  providerNotes: String

  # Evidence
  guidelineReference: String

  createdAt: DateTime!
  updatedAt: DateTime!
}

type CarePlanTemplate @key(fields: "id") {
  id: ID!

  # Template metadata
  name: String!
  category: TemplateCategory!
  conditionCodes: [String!]!

  # Template content
  defaultGoals: [TemplateGoal!]!
  defaultInterventions: [TemplateIntervention!]!

  # Source
  guidelineSource: String
  evidenceGrade: String

  # Status
  isActive: Boolean!
  version: String!

  createdAt: DateTime!
  updatedAt: DateTime!
}

type TemplateGoal {
  description: String!
  defaultTargetValue: String
  defaultTargetDays: Int
  priority: GoalPriority!
}

type TemplateIntervention {
  type: InterventionType!
  description: String!
  medicationCode: String
  procedureCode: String
  defaultScheduleDays: Int
}

# =============================================================================
# PAGINATION
# =============================================================================

type CarePlanConnection {
  edges: [CarePlanEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type CarePlanEdge {
  node: CarePlan!
  cursor: String!
}

type CarePlanTemplateConnection {
  edges: [CarePlanTemplateEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type CarePlanTemplateEdge {
  node: CarePlanTemplate!
  cursor: String!
}

type PageInfo @shareable {
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: String
  endCursor: String
}

# =============================================================================
# INPUTS - All structured, NO free-text queries
# =============================================================================

input CreateCarePlanInput {
  patientId: ID!
  title: String!
  conditionCodes: [String!]!
  startDate: Date!
  targetEndDate: Date
  templateId: ID
  sourceTranscriptionId: ID
  sourceRAGSynthesisId: ID
}

input AddGoalInput {
  carePlanId: ID!
  description: String!
  targetValue: String
  targetDate: Date
  priority: GoalPriority!
  guidelineReference: String
}

input AddInterventionInput {
  carePlanId: ID!
  type: InterventionType!
  description: String!
  medicationCode: String
  dosage: String
  frequency: String
  procedureCode: String
  referralSpecialty: String
  scheduledDate: Date
  patientInstructions: String
  guidelineReference: String
}

input UpdateGoalStatusInput {
  goalId: ID!
  status: GoalStatus!
  progressNote: String
  currentValue: String
}

input UpdateInterventionStatusInput {
  interventionId: ID!
  status: InterventionStatus!
  completedDate: Date
  providerNotes: String
}

input CarePlanFilterInput {
  patientId: ID
  status: CarePlanStatus
  conditionCode: String
  createdAfter: DateTime
  createdBefore: DateTime
}

input TemplateFilterInput {
  category: TemplateCategory
  conditionCode: String
  isActive: Boolean
}

input PaginationInput {
  first: Int
  after: String
  last: Int
  before: String
}

# =============================================================================
# QUERIES - Structured lookups only
# =============================================================================

type Query {
  # Get single care plan by ID
  carePlan(id: ID!): CarePlan

  # List care plans with structured filters
  carePlans(
    filter: CarePlanFilterInput
    pagination: PaginationInput
  ): CarePlanConnection!

  # Get care plans for a patient
  carePlansForPatient(
    patientId: ID!
    status: CarePlanStatus
    pagination: PaginationInput
  ): CarePlanConnection!

  # Get active care plan for a patient (should be at most one)
  activeCarePlanForPatient(patientId: ID!): CarePlan

  # Get care plan template by ID
  carePlanTemplate(id: ID!): CarePlanTemplate

  # List templates with filters
  carePlanTemplates(
    filter: TemplateFilterInput
    pagination: PaginationInput
  ): CarePlanTemplateConnection!

  # Get applicable templates for conditions
  templatesForConditions(conditionCodes: [String!]!): [CarePlanTemplate!]!
}

# =============================================================================
# MUTATIONS
# =============================================================================

type Mutation {
  # Create a new care plan
  createCarePlan(input: CreateCarePlanInput!): CarePlan!

  # Create care plan from template
  createCarePlanFromTemplate(
    patientId: ID!
    templateId: ID!
    startDate: Date!
  ): CarePlan!

  # Update care plan status
  updateCarePlanStatus(id: ID!, status: CarePlanStatus!): CarePlan!

  # Add goal to care plan
  addGoal(input: AddGoalInput!): CarePlanGoal!

  # Add intervention to care plan
  addIntervention(input: AddInterventionInput!): CarePlanIntervention!

  # Update goal status/progress
  updateGoalStatus(input: UpdateGoalStatusInput!): CarePlanGoal!

  # Update intervention status
  updateInterventionStatus(input: UpdateInterventionStatusInput!): CarePlanIntervention!

  # Link goal to interventions
  linkGoalToInterventions(goalId: ID!, interventionIds: [ID!]!): CarePlanGoal!

  # Submit care plan for review
  submitCarePlanForReview(id: ID!): CarePlan!

  # Approve care plan (activates it)
  approveCarePlan(id: ID!): CarePlan!
}

# =============================================================================
# FEDERATION - Reference types from other subgraphs
# =============================================================================

# Extend Patient to add care plan fields
extend type Patient @key(fields: "id") {
  id: ID! @external
  carePlans(
    status: CarePlanStatus
    pagination: PaginationInput
  ): CarePlanConnection!
  activeCarePlan: CarePlan
}
