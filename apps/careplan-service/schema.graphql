extend schema @link(url: "https://specs.apollo.dev/federation/v2.10", import: ["@key", "@external", "@shareable"])

# Custom scalars
scalar DateTime
scalar Date

# =============================================================================
# ENUMS - Structured query types (NO free-text allowed per RFC)
# =============================================================================

enum CarePlanStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ACHIEVED
  NOT_ACHIEVED
  CANCELLED
}

enum GoalPriority {
  HIGH
  MEDIUM
  LOW
}

enum InterventionType {
  MEDICATION
  PROCEDURE
  LIFESTYLE
  MONITORING
  REFERRAL
  EDUCATION
  FOLLOW_UP
}

enum InterventionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DEFERRED
}

enum CarePlanQueryFilter {
  BY_PATIENT
  BY_PROVIDER
  BY_STATUS
  BY_CONDITION
}

enum TemplateCategory {
  CHRONIC_DISEASE
  ACUTE_CARE
  PREVENTIVE_CARE
  POST_PROCEDURE
  MEDICATION_MANAGEMENT
  LIFESTYLE_MODIFICATION
  MENTAL_HEALTH
  PEDIATRIC
  GERIATRIC
  GENERAL
}

# =============================================================================
# MAIN TYPES
# =============================================================================

type CarePlan @key(fields: "id") {
  id: ID!
  patient: Patient

  # Plan metadata
  title: String!
  status: CarePlanStatus!

  # Conditions being addressed (ICD-10 codes)
  conditionCodes: [String!]!

  # Plan components
  goals: [CarePlanGoal!]!
  interventions: [CarePlanIntervention!]!

  # Timeline
  startDate: Date!
  targetEndDate: Date
  actualEndDate: Date

  # Review schedule
  nextReviewDate: Date
  lastReviewedAt: DateTime
  lastReviewedBy: ID

  # Source tracking
  sourceTranscriptionId: ID
  sourceRAGSynthesisId: ID
  templateId: ID

  # Training example fields (for RAG/ML training)
  isTrainingExample: Boolean!
  trainingDescription: String
  trainingTags: [String!]

  # Audit
  createdAt: DateTime!
  createdBy: ID
  updatedAt: DateTime!
}

type CarePlanGoal {
  id: ID!

  # Goal details
  description: String!
  targetValue: String
  targetDate: Date

  # Status
  status: GoalStatus!
  priority: GoalPriority!

  # Progress tracking
  progressNotes: [GoalProgressNote!]!
  currentValue: String
  percentComplete: Int

  # Linked interventions
  linkedInterventionIds: [ID!]!

  # Evidence
  guidelineReference: String

  createdAt: DateTime!
  updatedAt: DateTime!
}

type GoalProgressNote {
  id: ID!
  note: String!
  value: String
  recordedAt: DateTime!
  recordedBy: ID!
}

type CarePlanIntervention {
  id: ID!

  # Intervention details
  type: InterventionType!
  description: String!

  # For medication interventions
  medicationCode: String
  dosage: String
  frequency: String

  # For procedure/referral interventions
  procedureCode: String
  referralSpecialty: String

  # Scheduling
  status: InterventionStatus!
  scheduledDate: Date
  completedDate: Date

  # Instructions
  patientInstructions: String
  providerNotes: String

  # Evidence
  guidelineReference: String

  createdAt: DateTime!
  updatedAt: DateTime!
}

type CarePlanTemplate @key(fields: "id") {
  id: ID!

  # Template metadata
  name: String!
  description: String
  category: TemplateCategory!
  conditionCodes: [String!]!

  # Template content
  defaultGoals: [TemplateGoal!]!
  defaultInterventions: [TemplateIntervention!]!

  # Source
  guidelineSource: String
  evidenceGrade: String

  # Status
  isActive: Boolean!
  version: String!

  createdAt: DateTime!
  createdBy: ID
  updatedAt: DateTime!
}

type TemplateGoal {
  description: String!
  defaultTargetValue: String
  defaultTargetDays: Int
  priority: GoalPriority!
}

type TemplateIntervention {
  type: InterventionType!
  description: String!
  medicationCode: String
  procedureCode: String
  defaultScheduleDays: Int
}

# =============================================================================
# PAGINATION
# =============================================================================

type CarePlanConnection {
  edges: [CarePlanEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type CarePlanEdge {
  node: CarePlan!
  cursor: String!
}

type CarePlanTemplateConnection {
  edges: [CarePlanTemplateEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type CarePlanTemplateEdge {
  node: CarePlanTemplate!
  cursor: String!
}

type PageInfo @shareable {
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: String
  endCursor: String
}

# =============================================================================
# INPUTS - All structured, NO free-text queries
# =============================================================================

input CreateCarePlanInput {
  patientId: ID!
  title: String!
  conditionCodes: [String!]!
  startDate: Date!
  targetEndDate: Date
  templateId: ID
  sourceTranscriptionId: ID
  sourceRAGSynthesisId: ID
}

input AddGoalInput {
  carePlanId: ID!
  description: String!
  targetValue: String
  targetDate: Date
  priority: GoalPriority!
  guidelineReference: String
}

input AddInterventionInput {
  carePlanId: ID!
  type: InterventionType!
  description: String!
  medicationCode: String
  dosage: String
  frequency: String
  procedureCode: String
  referralSpecialty: String
  scheduledDate: Date
  patientInstructions: String
  guidelineReference: String
}

input UpdateGoalStatusInput {
  goalId: ID!
  status: GoalStatus!
  progressNote: String
  currentValue: String
}

input UpdateInterventionStatusInput {
  interventionId: ID!
  status: InterventionStatus!
  completedDate: Date
  providerNotes: String
}

input CarePlanFilterInput {
  patientId: ID
  status: CarePlanStatus
  conditionCode: String
  createdAfter: DateTime
  createdBefore: DateTime
}

input TemplateFilterInput {
  category: TemplateCategory
  conditionCode: String
  isActive: Boolean
}

input PaginationInput {
  first: Int
  after: String
  last: Int
  before: String
}

# =============================================================================
# TEMPLATE CRUD INPUTS
# =============================================================================

input CreateCarePlanTemplateInput {
  name: String!
  description: String
  category: TemplateCategory!
  conditionCodes: [String!]!
  guidelineSource: String
  evidenceGrade: String
  goals: [CreateTemplateGoalInput!]
  interventions: [CreateTemplateInterventionInput!]
}

input UpdateCarePlanTemplateInput {
  name: String
  description: String
  category: TemplateCategory
  conditionCodes: [String!]
  guidelineSource: String
  evidenceGrade: String
  isActive: Boolean
}

input CreateTemplateGoalInput {
  description: String!
  defaultTargetValue: String
  defaultTargetDays: Int
  priority: GoalPriority!
}

input CreateTemplateInterventionInput {
  type: InterventionType!
  description: String!
  medicationCode: String
  procedureCode: String
  defaultScheduleDays: Int
}

# =============================================================================
# TRAINING CARE PLAN INPUTS
# =============================================================================

input CreateTrainingCarePlanInput {
  title: String!
  conditionCodes: [String!]!
  trainingDescription: String
  trainingTags: [String!]
  startDate: Date!
  targetEndDate: Date
  goals: [CreateTrainingGoalInput!]
  interventions: [CreateTrainingInterventionInput!]
}

input UpdateTrainingCarePlanInput {
  title: String
  conditionCodes: [String!]
  trainingDescription: String
  trainingTags: [String!]
  startDate: Date
  targetEndDate: Date
  status: CarePlanStatus
}

input CreateTrainingGoalInput {
  description: String!
  targetValue: String
  targetDate: Date
  priority: GoalPriority!
  guidelineReference: String
}

input CreateTrainingInterventionInput {
  type: InterventionType!
  description: String!
  medicationCode: String
  dosage: String
  frequency: String
  procedureCode: String
  referralSpecialty: String
  scheduledDate: Date
  patientInstructions: String
  guidelineReference: String
}

input TrainingCarePlanFilterInput {
  status: CarePlanStatus
  conditionCode: String
  trainingTag: String
  createdAfter: DateTime
  createdBefore: DateTime
}

# =============================================================================
# DOCUMENT IMPORT/EXPORT TYPES
# =============================================================================

input ImportDocumentInput {
  documentText: String!
  patientId: ID!
  createTemplate: Boolean
}

type ImportDocumentResult {
  carePlan: CarePlan!
  validationReport: DocumentValidationReport!
}

type ExportDocumentResult {
  documentText: String!
  filename: String!
}

type DocumentValidationReport {
  isValid: Boolean!
  violations: [DocumentValidationViolation!]!
  crossReferenceIssues: [CrossReferenceIssue!]!
}

type DocumentValidationViolation {
  rule: String!
  severity: String!
  message: String!
  line: Int
}

type CrossReferenceIssue {
  code: String!
  severity: String!
  message: String!
}

# =============================================================================
# PDF IMPORT INPUTS
# =============================================================================

input ImportCarePlanFromPdfInput {
  # Basic info
  title: String!
  description: String
  category: TemplateCategory!

  # Medical codes
  conditionCodes: [String!]!
  medicationCodes: [String!]
  labCodes: [String!]

  # Raw text for RAG embeddings
  rawText: String!

  # Goals and interventions
  goals: [CreateTemplateGoalInput!]
  interventions: [CreateTemplateInterventionInput!]

  # Import options
  createTemplate: Boolean!
  createTrainingExample: Boolean!

  # Training metadata (only used if createTrainingExample is true)
  trainingTags: [String!]
  trainingDescription: String
}

type ImportCarePlanFromPdfResult {
  template: CarePlanTemplate
  trainingExample: CarePlan
  embeddingGenerated: Boolean!
}

# =============================================================================
# QUERIES - Structured lookups only
# =============================================================================

type Query {
  # Get single care plan by ID
  carePlan(id: ID!): CarePlan

  # List care plans with structured filters
  carePlans(
    filter: CarePlanFilterInput
    pagination: PaginationInput
  ): CarePlanConnection!

  # Get care plans for a patient
  carePlansForPatient(
    patientId: ID!
    status: CarePlanStatus
    pagination: PaginationInput
  ): CarePlanConnection!

  # Get active care plan for a patient (should be at most one)
  activeCarePlanForPatient(patientId: ID!): CarePlan

  # Get care plan template by ID
  carePlanTemplate(id: ID!): CarePlanTemplate

  # List templates with filters
  carePlanTemplates(
    filter: TemplateFilterInput
    pagination: PaginationInput
  ): CarePlanTemplateConnection!

  # Get applicable templates for conditions
  templatesForConditions(conditionCodes: [String!]!): [CarePlanTemplate!]!

  # Training care plans (for RAG/ML training context)
  trainingCarePlans(
    filter: TrainingCarePlanFilterInput
    pagination: PaginationInput
  ): CarePlanConnection!

  trainingCarePlan(id: ID!): CarePlan

  # Export care plan as structured document
  exportCarePlanDocument(carePlanId: ID!): ExportDocumentResult!

  # Validate a document without persisting
  validateCarePlanDocument(documentText: String!): DocumentValidationReport!
}

# =============================================================================
# MUTATIONS
# =============================================================================

type Mutation {
  # Create a new care plan
  createCarePlan(input: CreateCarePlanInput!): CarePlan!

  # Create care plan from template
  createCarePlanFromTemplate(
    patientId: ID!
    templateId: ID!
    startDate: Date!
  ): CarePlan!

  # Update care plan status
  updateCarePlanStatus(id: ID!, status: CarePlanStatus!): CarePlan!

  # Add goal to care plan
  addGoal(input: AddGoalInput!): CarePlanGoal!

  # Add intervention to care plan
  addIntervention(input: AddInterventionInput!): CarePlanIntervention!

  # Update goal status/progress
  updateGoalStatus(input: UpdateGoalStatusInput!): CarePlanGoal!

  # Update intervention status
  updateInterventionStatus(input: UpdateInterventionStatusInput!): CarePlanIntervention!

  # Link goal to interventions
  linkGoalToInterventions(goalId: ID!, interventionIds: [ID!]!): CarePlanGoal!

  # Submit care plan for review
  submitCarePlanForReview(id: ID!): CarePlan!

  # Approve care plan (activates it)
  approveCarePlan(id: ID!): CarePlan!

  # =============================================================================
  # TEMPLATE CRUD MUTATIONS
  # =============================================================================

  # Create a new care plan template
  createCarePlanTemplate(input: CreateCarePlanTemplateInput!): CarePlanTemplate!

  # Update a care plan template
  updateCarePlanTemplate(id: ID!, input: UpdateCarePlanTemplateInput!): CarePlanTemplate!

  # Delete a care plan template
  deleteCarePlanTemplate(id: ID!): Boolean!

  # =============================================================================
  # TRAINING CARE PLAN MUTATIONS
  # =============================================================================

  # Create a training care plan (for RAG/ML training)
  createTrainingCarePlan(input: CreateTrainingCarePlanInput!): CarePlan!

  # Update a training care plan
  updateTrainingCarePlan(id: ID!, input: UpdateTrainingCarePlanInput!): CarePlan!

  # Delete a training care plan
  deleteTrainingCarePlan(id: ID!): Boolean!

  # Add goal to training care plan
  addTrainingGoal(carePlanId: ID!, input: CreateTrainingGoalInput!): CarePlan!

  # Remove goal from training care plan
  removeTrainingGoal(goalId: ID!): Boolean!

  # Add intervention to training care plan
  addTrainingIntervention(carePlanId: ID!, input: CreateTrainingInterventionInput!): CarePlan!

  # Remove intervention from training care plan
  removeTrainingIntervention(interventionId: ID!): Boolean!

  # =============================================================================
  # PDF IMPORT MUTATIONS
  # =============================================================================

  # Import care plan from PDF extracted data
  # Creates template and/or training example based on options
  importCarePlanFromPdf(input: ImportCarePlanFromPdfInput!): ImportCarePlanFromPdfResult!

  # Import care plan from structured document text
  importCarePlanDocument(input: ImportDocumentInput!): ImportDocumentResult!
}

# =============================================================================
# FEDERATION - Reference types from other subgraphs
# =============================================================================

# Extend Patient to add care plan fields
extend type Patient @key(fields: "id") {
  id: ID! @external
  carePlans(
    status: CarePlanStatus
    pagination: PaginationInput
  ): CarePlanConnection!
  activeCarePlan: CarePlan
}
